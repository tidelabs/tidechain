<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Transforms a given module into one that charges gas for code to be executed by proxy of an imported gas metering function."><meta name="keywords" content="rust, rustlang, rust-lang, inject"><title>inject in wasm_instrument::gas_metering - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../wasm_instrument/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../wasm_instrument/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><div class="sidebar-elems"><h2><a href="index.html">In wasm_instrument::gas_metering</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Function <a href="../index.html">wasm_instrument</a>::<wbr><a href="index.html">gas_metering</a>::<wbr><a class="fn" href="#">inject</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../src/wasm_instrument/gas_metering/mod.rs.html#138-228">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><div class="item-decl"><pre class="rust fn"><code>pub fn inject&lt;R:&nbsp;<a class="trait" href="trait.Rules.html" title="trait wasm_instrument::gas_metering::Rules">Rules</a>&gt;(<br>&nbsp;&nbsp;&nbsp;&nbsp;module: <a class="struct" href="../../parity_wasm/elements/module/struct.Module.html" title="struct parity_wasm::elements::module::Module">Module</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;rules: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.reference.html">&amp;</a>R,<br>&nbsp;&nbsp;&nbsp;&nbsp;gas_module_name: &amp;<a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.str.html">str</a><br>) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.66.1/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;<a class="struct" href="../../parity_wasm/elements/module/struct.Module.html" title="struct parity_wasm::elements::module::Module">Module</a>, <a class="struct" href="../../parity_wasm/elements/module/struct.Module.html" title="struct parity_wasm::elements::module::Module">Module</a>&gt;</code></pre></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Transforms a given module into one that charges gas for code to be executed by proxy of an
imported gas metering function.</p>
<p>The output module imports a function “gas” from the specified module with type signature
<a href="https://doc.rust-lang.org/1.66.1/std/primitive.i32.html" title="i32">i32</a> -&gt; []. The argument is the amount of gas required to continue execution. The external
function is meant to keep track of the total amount of gas used and trap or otherwise halt
execution of the runtime if the gas usage exceeds some allowed limit.</p>
<p>The body of each function is divided into metered blocks, and the calls to charge gas are
inserted at the beginning of every such block of code. A metered block is defined so that,
unless there is a trap, either all of the instructions are executed or none are. These are
similar to basic blocks in a control flow graph, except that in some cases multiple basic
blocks can be merged into a single metered block. This is the case if any path through the
control flow graph containing one basic block also contains another.</p>
<p>Charging gas is at the beginning of each metered block ensures that 1) all instructions
executed are already paid for, 2) instructions that will not be executed are not charged for
unless execution traps, and 3) the number of calls to “gas” is minimized. The corollary is that
modules instrumented with this metering code may charge gas for instructions not executed in
the event of a trap.</p>
<p>Additionally, each <code>memory.grow</code> instruction found in the module is instrumented to first make
a call to charge gas for the additional pages requested. This cannot be done as part of the
block level gas charges as the gas cost is not static and depends on the stack argument to
<code>memory.grow</code>.</p>
<p>The above transformations are performed for every function body defined in the module. This
function also rewrites all function indices references by code, table elements, etc., since
the addition of an imported functions changes the indices of module-defined functions.</p>
<p>This routine runs in time linear in the size of the input module.</p>
<p>The function fails if the module contains any operation forbidden by gas rule set, returning
the original module as an Err.</p>
</div></details></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="wasm_instrument" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.1 (90743e729 2023-01-10)" ></div></body></html>